{{- define "main" -}}
<article>
  <header class="mb-14">
    <h1 class="my-0! pb-2.5">{{- .Title -}}</h1>
  </header>

  <!-- ğŸ“š Reading -->
  <section class="activity-section">
    <h2>&#128218; Reading</h2>
    <div class="charts-grid">
      <div class="chart-container">
        <h3>Articles Read</h3>
        <canvas id="chart-total-words"></canvas>
      </div>
      <div class="chart-container">
        <h3>Books Finished</h3>
        <canvas id="chart-books-finished"></canvas>
      </div>
    </div>
  </section>

  <!-- ğŸ—ºï¸ Travel -->
  <section class="activity-section">
    <h2>ğŸ—ºï¸ Travel</h2>
    <div class="charts-grid">
      <div class="chart-container">
        <h3>Check-ins &amp; Unique Places</h3>
        <canvas id="chart-travel-combo"></canvas>
      </div>
    </div>
  </section>

  <!-- ğŸ¬ Movies -->
  <section class="activity-section">
    <h2>ğŸ¬ Movies</h2>
    <div class="charts-grid">
      <div class="chart-container">
        <h3>Movies Watched &amp; Rating</h3>
        <canvas id="chart-movies-combo"></canvas>
      </div>
    </div>
  </section>

  <!-- ğŸ§ Podcasts -->
  <section class="activity-section">
    <h2>ğŸ§ Podcasts</h2>
    <div class="charts-grid">
      <div class="chart-container">
        <h3>Episodes Played</h3>
        <canvas id="chart-episodes-played"></canvas>
      </div>
      <div class="chart-container">
        <h3>Feed Changes</h3>
        <canvas id="chart-feed-changes"></canvas>
      </div>
    </div>
  </section>

  <!-- ğŸ‹ï¸ Workout -->
  <section class="activity-section">
    <h2>ğŸ‹ï¸ Workout</h2>
    <div class="charts-grid">
      <div class="chart-container">
        <h3>Workouts &amp; Minutes</h3>
        <canvas id="chart-workout-combo"></canvas>
      </div>
    </div>
  </section>

  <!-- ğŸ’» Code -->
  <section class="activity-section">
    <h2>ğŸ’» Code</h2>
    <div class="charts-grid">
      <div class="chart-container">
        <h3>Monthly Commits</h3>
        <canvas id="chart-monthly-commits"></canvas>
      </div>
      <div class="chart-container">
        <h3>Daily Contributions</h3>
        <img id="github-contrib-graph" src="https://ghchart.rshah.org/yyl" alt="GitHub contribution graph"
          style="width: 100%; border-radius: 4px;" />
      </div>
    </div>
  </section>

  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" defer></script>

  <script>
    // Data from Hugo
    const readingData = {{ .Site.Data.activity.reading | jsonify | safeJS }};
    const travelData = {{ .Site.Data.activity.travel | jsonify | safeJS }};
    const moviesData = {{ .Site.Data.activity.movies | jsonify | safeJS }};
    const podcastsData = {{ .Site.Data.activity.podcasts | jsonify | safeJS }};
    const booksData = {{ .Site.Data.activity.books | jsonify | safeJS }};
    const workoutsData = {{ .Site.Data.activity.workouts | jsonify | safeJS }};
    const codeData = {{ .Site.Data.activity.code | jsonify | safeJS }};

    // Detect dark mode
    const isDark = () => document.documentElement.classList.contains('dark');

    // Theme colors
    const getColors = () => ({
      bar: isDark() ? 'rgba(209, 213, 219, 0.8)' : 'rgba(55, 65, 81, 0.8)',
      barHover: isDark() ? 'rgba(209, 213, 219, 1)' : 'rgba(55, 65, 81, 1)',
      grid: isDark() ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)',
      text: isDark() ? 'rgba(255, 255, 255, 0.7)' : 'rgba(0, 0, 0, 0.7)'
    });

    // Chart defaults
    const createChart = (ctx, labels, data, label) => {
      const colors = getColors();
      return new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: label,
            data: data,
            backgroundColor: colors.bar,
            hoverBackgroundColor: colors.barHover,
            borderRadius: 4,
            borderSkipped: false
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: { display: false }
          },
          scales: {
            x: {
              grid: { display: false },
              ticks: {
                color: colors.text,
                autoSkip: false,
                maxRotation: 0
              }
            },
            y: {
              beginAtZero: true,
              grid: { color: colors.grid },
              ticks: { color: colors.text }
            }
          }
        }
      });
    };

    // Diverging bar chart (positive + negative)
    const createDualChart = (ctx, labels, addedData, removedData) => {
      const colors = getColors();
      return new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'Added',
              data: addedData,
              backgroundColor: isDark() ? 'rgba(134, 239, 172, 0.7)' : 'rgba(34, 197, 94, 0.7)',
              hoverBackgroundColor: isDark() ? 'rgba(134, 239, 172, 1)' : 'rgba(34, 197, 94, 1)',
              borderRadius: 4,
              borderSkipped: false
            },
            {
              label: 'Removed',
              data: removedData.map(v => -v),
              backgroundColor: isDark() ? 'rgba(252, 165, 165, 0.7)' : 'rgba(239, 68, 68, 0.7)',
              hoverBackgroundColor: isDark() ? 'rgba(252, 165, 165, 1)' : 'rgba(239, 68, 68, 1)',
              borderRadius: 4,
              borderSkipped: false
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: { display: true, labels: { color: colors.text } },
            tooltip: {
              callbacks: {
                label: (ctx) => ctx.dataset.label + ': ' + Math.abs(ctx.raw)
              }
            }
          },
          scales: {
            x: {
              stacked: true,
              grid: { display: false },
              ticks: { color: colors.text, autoSkip: false, maxRotation: 0 }
            },
            y: {
              grid: { color: colors.grid },
              ticks: {
                color: colors.text,
                callback: (v) => Math.abs(v)
              }
            }
          }
        }
      });
    };

    // Format month labels as two-level: month on top, year only at year boundary
    const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    const formatLabels = (dataSlice) => {
      let lastYear = null;
      return dataSlice.map(d => {
        const [year, month] = d.month.split('-');
        const monthLabel = monthNames[parseInt(month) - 1];
        if (year !== lastYear) {
          lastYear = year;
          return [monthLabel, year];
        }
        return monthLabel;
      });
    };

    // Show "No data available yet" message for missing data
    const showNoData = (canvasId) => {
      const canvas = document.getElementById(canvasId);
      if (canvas) {
        const container = canvas.parentElement;
        canvas.style.display = 'none';
        const msg = document.createElement('p');
        msg.textContent = 'No data available yet';
        msg.style.cssText = 'opacity: 0.5; font-style: italic; text-align: center; padding: 2rem 0;';
        container.appendChild(msg);
      }
    };

    // Exclude current (incomplete) month
    const now = new Date();
    const currentMonth = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0');

    // Fill gaps in monthly data so missing months show as 0
    const fillMonthGaps = (data, fields) => {
      if (!data || data.length < 2) return data;
      const filled = [];
      for (let i = 0; i < data.length; i++) {
        filled.push(data[i]);
        if (i < data.length - 1) {
          let [y, m] = data[i].month.split('-').map(Number);
          const [ny, nm] = data[i + 1].month.split('-').map(Number);
          m++;
          if (m > 12) { m = 1; y++; }
          while (y < ny || (y === ny && m < nm)) {
            const entry = { month: y + '-' + String(m).padStart(2, '0') };
            fields.forEach(f => entry[f] = 0);
            filled.push(entry);
            m++;
            if (m > 12) { m = 1; y++; }
          }
        }
      }
      return filled;
    };

    // Safely initialize charts with data validation
    const initCharts = (data, chartConfigs, gapFields) => {
      if (!data || !Array.isArray(data) || data.length === 0) {
        chartConfigs.forEach(config => showNoData(config.id));
        return;
      }
      const completed = data.filter(d => d.month !== currentMonth);
      const gapped = gapFields ? fillMonthGaps(completed, gapFields) : completed;
      const recent = gapped.slice(-12);
      const labels = formatLabels(recent);
      chartConfigs.forEach(config => {
        createChart(document.getElementById(config.id), labels, recent.map(d => d[config.field]), config.label);
      });
    };

    // Initialize charts
    document.addEventListener('DOMContentLoaded', () => {
      // Reading combo chart (bar: total words, line: avg reading speed)
      if (readingData && Array.isArray(readingData) && readingData.length > 0) {
        const completedReading = fillMonthGaps(readingData.filter(d => d.month !== currentMonth), ['total_words', 'time_spent_minutes']);
        const recentReading = completedReading.slice(-12);
        const readingLabels = formatLabels(recentReading);
        const colors = getColors();
        new Chart(document.getElementById('chart-total-words'), {
          type: 'bar',
          data: {
            labels: readingLabels,
            datasets: [
              {
                type: 'bar',
                label: 'Total Words',
                data: recentReading.map(d => d.total_words),
                backgroundColor: colors.bar,
                hoverBackgroundColor: colors.barHover,
                borderRadius: 4,
                borderSkipped: false,
                yAxisID: 'y'
              },
              {
                type: 'line',
                label: 'Minutes Read',
                data: recentReading.map(d => d.time_spent_minutes),
                borderColor: isDark() ? 'rgba(251, 191, 36, 0.9)' : 'rgba(217, 119, 6, 0.9)',
                backgroundColor: isDark() ? 'rgba(251, 191, 36, 0.2)' : 'rgba(217, 119, 6, 0.2)',
                borderWidth: 2,
                pointRadius: 4,
                pointBackgroundColor: isDark() ? 'rgba(251, 191, 36, 1)' : 'rgba(217, 119, 6, 1)',
                tension: 0.3,
                fill: false,
                yAxisID: 'y1'
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
              legend: { display: true, labels: { color: colors.text } }
            },
            scales: {
              x: {
                grid: { display: false },
                ticks: { color: colors.text, autoSkip: false, maxRotation: 0 }
              },
              y: {
                beginAtZero: true,
                position: 'left',
                grid: { color: colors.grid },
                ticks: {
                  color: colors.text,
                  callback: (v) => v >= 1000 ? (v / 1000) + 'k' : v
                },
                title: { display: true, text: 'Words', color: colors.text }
              },
              y1: {
                beginAtZero: true,
                position: 'right',
                grid: { drawOnChartArea: false },
                ticks: { color: isDark() ? 'rgba(251, 191, 36, 0.9)' : 'rgba(217, 119, 6, 0.9)' },
                title: { display: true, text: 'Minutes', color: isDark() ? 'rgba(251, 191, 36, 0.9)' : 'rgba(217, 119, 6, 0.9)' }
              }
            }
          }
        });
      } else {
        showNoData('chart-total-words');
      }

      // Books chart
      initCharts(booksData, [
        { id: 'chart-books-finished', field: 'books_finished', label: 'Books' }
      ], ['books_finished']);

      // Workout combo chart (bar + line with dual y-axes)
      if (workoutsData && Array.isArray(workoutsData) && workoutsData.length > 0) {
        const completedWorkouts = fillMonthGaps(workoutsData.filter(d => d.month !== currentMonth), ['workouts', 'total_minutes']);
        const recentWorkouts = completedWorkouts.slice(-12);
        const workoutLabels = formatLabels(recentWorkouts);
        const colors = getColors();
        new Chart(document.getElementById('chart-workout-combo'), {
          type: 'bar',
          data: {
            labels: workoutLabels,
            datasets: [
              {
                type: 'bar',
                label: 'Workouts',
                data: recentWorkouts.map(d => d.workouts),
                backgroundColor: colors.bar,
                hoverBackgroundColor: colors.barHover,
                borderRadius: 4,
                borderSkipped: false,
                yAxisID: 'y'
              },
              {
                type: 'line',
                label: 'Minutes',
                data: recentWorkouts.map(d => d.total_minutes),
                borderColor: isDark() ? 'rgba(251, 191, 36, 0.9)' : 'rgba(217, 119, 6, 0.9)',
                backgroundColor: isDark() ? 'rgba(251, 191, 36, 0.2)' : 'rgba(217, 119, 6, 0.2)',
                borderWidth: 2,
                pointRadius: 4,
                pointBackgroundColor: isDark() ? 'rgba(251, 191, 36, 1)' : 'rgba(217, 119, 6, 1)',
                tension: 0.3,
                fill: false,
                yAxisID: 'y1'
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
              legend: { display: true, labels: { color: colors.text } }
            },
            scales: {
              x: {
                grid: { display: false },
                ticks: { color: colors.text, autoSkip: false, maxRotation: 0 }
              },
              y: {
                beginAtZero: true,
                position: 'left',
                grid: { color: colors.grid },
                ticks: { color: colors.text },
                title: { display: true, text: 'Workouts', color: colors.text }
              },
              y1: {
                beginAtZero: true,
                position: 'right',
                grid: { drawOnChartArea: false },
                ticks: { color: isDark() ? 'rgba(251, 191, 36, 0.9)' : 'rgba(217, 119, 6, 0.9)' },
                title: { display: true, text: 'Minutes', color: isDark() ? 'rgba(251, 191, 36, 0.9)' : 'rgba(217, 119, 6, 0.9)' }
              }
            }
          }
        });
      } else {
        showNoData('chart-workout-combo');
      }

      // Travel combo chart (overlaid bars)
      if (travelData && Array.isArray(travelData) && travelData.length > 0) {
        const recentTravel = fillMonthGaps(travelData.filter(d => d.month !== currentMonth), ['checkins', 'unique_places']).slice(-12);
        const travelLabels = formatLabels(recentTravel);
        const colors = getColors();
        new Chart(document.getElementById('chart-travel-combo'), {
          type: 'bar',
          data: {
            labels: travelLabels,
            datasets: [
              {
                label: 'Check-ins',
                data: recentTravel.map(d => d.checkins),
                backgroundColor: colors.bar,
                hoverBackgroundColor: colors.barHover,
                borderRadius: 4,
                borderSkipped: false,
                barPercentage: 0.8,
                categoryPercentage: 0.7,
                xAxisID: 'x',
                order: 2
              },
              {
                label: 'Unique Places',
                data: recentTravel.map(d => d.unique_places),
                backgroundColor: 'rgba(239, 68, 68, 0.7)',
                hoverBackgroundColor: 'rgba(239, 68, 68, 1)',
                borderRadius: 4,
                borderSkipped: false,
                barPercentage: 0.8,
                categoryPercentage: 0.7,
                xAxisID: 'x2',
                order: 1
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
              legend: { display: true, labels: { color: colors.text } }
            },
            scales: {
              x: {
                grid: { display: false },
                ticks: { color: colors.text, autoSkip: false, maxRotation: 0 }
              },
              x2: {
                display: false,
                grid: { display: false },
                offset: true
              },
              y: {
                beginAtZero: true,
                grid: { color: colors.grid },
                ticks: { color: colors.text }
              }
            }
          }
        });
      } else {
        showNoData('chart-travel-combo');
      }

      // Movies combo chart (bar + line with dual y-axes)
      if (moviesData && Array.isArray(moviesData) && moviesData.length > 0) {
        const recentMovies = fillMonthGaps(moviesData.filter(d => d.month !== currentMonth), ['movies_watched', 'avg_rating']).slice(-12);
        const moviesLabels = formatLabels(recentMovies);
        const colors = getColors();
        new Chart(document.getElementById('chart-movies-combo'), {
          type: 'bar',
          data: {
            labels: moviesLabels,
            datasets: [
              {
                type: 'bar',
                label: 'Movies Watched',
                data: recentMovies.map(d => d.movies_watched),
                backgroundColor: colors.bar,
                hoverBackgroundColor: colors.barHover,
                borderRadius: 4,
                borderSkipped: false,
                yAxisID: 'y'
              },
              {
                type: 'line',
                label: 'Avg Rating',
                data: recentMovies.map(d => d.avg_rating),
                borderColor: isDark() ? 'rgba(251, 191, 36, 0.9)' : 'rgba(217, 119, 6, 0.9)',
                backgroundColor: isDark() ? 'rgba(251, 191, 36, 0.2)' : 'rgba(217, 119, 6, 0.2)',
                borderWidth: 2,
                pointRadius: 4,
                pointBackgroundColor: isDark() ? 'rgba(251, 191, 36, 1)' : 'rgba(217, 119, 6, 1)',
                tension: 0.3,
                fill: false,
                yAxisID: 'y1'
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
              legend: { display: true, labels: { color: colors.text } }
            },
            scales: {
              x: {
                grid: { display: false },
                ticks: { color: colors.text, autoSkip: false, maxRotation: 0 }
              },
              y: {
                beginAtZero: true,
                position: 'left',
                grid: { color: colors.grid },
                ticks: { color: colors.text },
                title: { display: true, text: 'Movies', color: colors.text }
              },
              y1: {
                beginAtZero: true,
                position: 'right',
                grid: { drawOnChartArea: false },
                ticks: { color: isDark() ? 'rgba(251, 191, 36, 0.9)' : 'rgba(217, 119, 6, 0.9)' },
                title: { display: true, text: 'Rating', color: isDark() ? 'rgba(251, 191, 36, 0.9)' : 'rgba(217, 119, 6, 0.9)' },
                max: 5
              }
            }
          }
        });
      } else {
        showNoData('chart-movies-combo');
      }

      // Podcasts charts
      initCharts(podcastsData, [
        { id: 'chart-episodes-played', field: 'episodes_played', label: 'Episodes' }
      ], ['episodes_played', 'feeds_added', 'feeds_removed']);

      // Feed changes (dual chart)
      if (podcastsData && Array.isArray(podcastsData) && podcastsData.length > 0) {
        const recentPodcasts = fillMonthGaps(podcastsData.filter(d => d.month !== currentMonth), ['feeds_added', 'feeds_removed']).slice(-12);
        const feedLabels = formatLabels(recentPodcasts);
        createDualChart(
          document.getElementById('chart-feed-changes'),
          feedLabels,
          recentPodcasts.map(d => d.feeds_added),
          recentPodcasts.map(d => d.feeds_removed)
        );
      } else {
        showNoData('chart-feed-changes');
      }

      // Code charts
      initCharts(codeData, [
        { id: 'chart-monthly-commits', field: 'commits', label: 'Commits' }
      ], ['commits', 'repos_touched']);
    });

    // Update GitHub images on dark mode toggle (avoids full page reload)
    const GH_USER = 'yyl';
    const updateGithubImages = (dark) => {
      const contrib = document.getElementById('github-contrib-graph');
      const stats = document.getElementById('github-stats');
      if (contrib) {
        contrib.src = dark
          ? `https://ghchart.rshah.org/58a6ff/${GH_USER}`
          : `https://ghchart.rshah.org/${GH_USER}`;
      }
      if (stats) {
        const theme = dark ? 'dark' : 'default';
        stats.src = `https://github-readme-stats.vercel.app/api?username=${GH_USER}&show_icons=true&count_private=true&hide_border=true&theme=${theme}`;
      }
    };

    // Set initial state
    updateGithubImages(isDark());

    // Watch for dark mode changes (debounced to avoid reload loops)
    let lastDarkState = isDark();
    const observer = new MutationObserver(() => {
      const currentDarkState = isDark();
      if (currentDarkState !== lastDarkState) {
        lastDarkState = currentDarkState;
        updateGithubImages(currentDarkState);
        location.reload();
      }
    });
    observer.observe(document.documentElement, { attributes: true, attributeFilter: ['class'] });
  </script>
</article>
{{- end -}}