{{- define "main" -}}
<article>
  <header class="mb-14">
    <h1 class="my-0! pb-2.5">{{- .Title -}}</h1>
  </header>

  <section>
    <!-- Tab Navigation -->
    <div class="activity-tabs">
      <input type="radio" name="activity-tab" id="tab-reading" checked>
      <label for="tab-reading">üìö Reading</label>

      <input type="radio" name="activity-tab" id="tab-travel">
      <label for="tab-travel">üó∫Ô∏è Travel</label>

      <input type="radio" name="activity-tab" id="tab-movies">
      <label for="tab-movies">üé¨ Movies</label>

      <input type="radio" name="activity-tab" id="tab-podcasts">
      <label for="tab-podcasts">üéß Podcasts</label>

      <input type="radio" name="activity-tab" id="tab-workout">
      <label for="tab-workout">üèãÔ∏è Workout</label>

      <!-- Reading Tab Content -->
      <div class="tab-content" id="content-reading">
        <div class="charts-grid">
          <div class="chart-container">
            <h3>Articles Archived</h3>
            <canvas id="chart-articles-archived"></canvas>
          </div>
          <div class="chart-container">
            <h3>Total Words Read</h3>
            <canvas id="chart-total-words"></canvas>
          </div>
          <div class="chart-container">
            <h3>Time Spent Reading (minutes)</h3>
            <canvas id="chart-time-spent"></canvas>
          </div>
          <div class="chart-container">
            <h3>Books Finished</h3>
            <canvas id="chart-books-finished"></canvas>
          </div>
        </div>
      </div>

      <!-- Travel Tab Content -->
      <div class="tab-content" id="content-travel">
        <div class="charts-grid">
          <div class="chart-container">
            <h3>Check-ins & Unique Places</h3>
            <canvas id="chart-travel-combo"></canvas>
          </div>
        </div>
      </div>

      <!-- Movies Tab Content -->
      <div class="tab-content" id="content-movies">
        <div class="charts-grid">
          <div class="chart-container">
            <h3>Movies Watched & Rating</h3>
            <canvas id="chart-movies-combo"></canvas>
          </div>
        </div>
      </div>

      <!-- Podcasts Tab Content -->
      <div class="tab-content" id="content-podcasts">
        <div class="charts-grid">
          <div class="chart-container">
            <h3>Episodes Played</h3>
            <canvas id="chart-episodes-played"></canvas>
          </div>
          <div class="chart-container">
            <h3>Feed Changes</h3>
            <canvas id="chart-feed-changes"></canvas>
          </div>
        </div>
      </div>

      <!-- Workout Tab Content -->
      <div class="tab-content" id="content-workout">
        <div class="charts-grid">
          <div class="chart-container">
            <h3>Workouts & Minutes</h3>
            <canvas id="chart-workout-combo"></canvas>
          </div>
        </div>
      </div>
    </div>
  </section>

  <style>
    /* Tab Styling */
    .activity-tabs {
      display: flex;
      flex-wrap: wrap;
      gap: 0;
    }

    .activity-tabs input[type="radio"] {
      display: none;
    }

    .activity-tabs label {
      padding: 0.75rem 1.25rem;
      cursor: pointer;
      font-weight: 500;
      border-radius: 0.5rem 0.5rem 0 0;
      background: rgba(0, 0, 0, 0.03);
      transition: background 0.2s ease;
      margin-right: 0.25rem;
    }

    .dark .activity-tabs label {
      background: rgba(255, 255, 255, 0.08);
    }

    .activity-tabs label:hover {
      background: rgba(0, 0, 0, 0.06);
    }

    .dark .activity-tabs label:hover {
      background: rgba(255, 255, 255, 0.12);
    }

    .activity-tabs input[type="radio"]:checked+label {
      background: rgba(0, 0, 0, 0.08);
      color: #000;
    }

    .dark .activity-tabs input[type="radio"]:checked+label {
      background: rgba(255, 255, 255, 0.16);
      color: #fff;
    }

    /* Tab Content */
    .tab-content {
      display: none;
      width: 100%;
      order: 99;
      padding: 1.5rem 0;
    }

    #tab-reading:checked~#content-reading,
    #tab-travel:checked~#content-travel,
    #tab-movies:checked~#content-movies,
    #tab-podcasts:checked~#content-podcasts,
    #tab-workout:checked~#content-workout {
      display: block;
    }

    /* Charts Grid */
    .charts-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 2rem;
    }

    .chart-container {
      background: rgba(0, 0, 0, 0.02);
      border-radius: 0.75rem;
      padding: 1.25rem;
    }

    .dark .chart-container {
      background: rgba(255, 255, 255, 0.05);
    }

    .chart-container h3 {
      margin: 0 0 1rem 0;
      font-size: 1rem;
      font-weight: 600;
      opacity: 0.8;
    }

    .chart-container canvas {
      width: 100% !important;
      max-height: 200px;
    }

    /* Responsive */
    @media (max-width: 640px) {
      .activity-tabs label {
        padding: 0.5rem 0.75rem;
        font-size: 0.875rem;
      }

      .charts-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>

  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <script>
    // Data from Hugo
    const readingData = {{ .Site.Data.activity.reading | jsonify | safeJS }};
    const travelData = {{ .Site.Data.activity.travel | jsonify | safeJS }};
    const moviesData = {{ .Site.Data.activity.movies | jsonify | safeJS }};
    const podcastsData = {{ .Site.Data.activity.podcasts | jsonify | safeJS }};
    const booksData = {{ .Site.Data.activity.books | jsonify | safeJS }};
    const workoutsData = {{ .Site.Data.activity.workouts | jsonify | safeJS }};

    // Detect dark mode
    const isDark = () => document.documentElement.classList.contains('dark');

    // Theme colors
    const getColors = () => ({
      bar: isDark() ? 'rgba(209, 213, 219, 0.8)' : 'rgba(55, 65, 81, 0.8)',
      barHover: isDark() ? 'rgba(209, 213, 219, 1)' : 'rgba(55, 65, 81, 1)',
      grid: isDark() ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)',
      text: isDark() ? 'rgba(255, 255, 255, 0.7)' : 'rgba(0, 0, 0, 0.7)'
    });

    // Chart defaults
    const createChart = (ctx, labels, data, label) => {
      const colors = getColors();
      return new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: label,
            data: data,
            backgroundColor: colors.bar,
            hoverBackgroundColor: colors.barHover,
            borderRadius: 4,
            borderSkipped: false
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: { display: false }
          },
          scales: {
            x: {
              grid: { display: false },
              ticks: {
                color: colors.text,
                autoSkip: false,
                maxRotation: 0
              }
            },
            y: {
              beginAtZero: true,
              grid: { color: colors.grid },
              ticks: { color: colors.text }
            }
          }
        }
      });
    };

    // Diverging bar chart (positive + negative)
    const createDualChart = (ctx, labels, addedData, removedData) => {
      const colors = getColors();
      return new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'Added',
              data: addedData,
              backgroundColor: isDark() ? 'rgba(134, 239, 172, 0.7)' : 'rgba(34, 197, 94, 0.7)',
              hoverBackgroundColor: isDark() ? 'rgba(134, 239, 172, 1)' : 'rgba(34, 197, 94, 1)',
              borderRadius: 4,
              borderSkipped: false
            },
            {
              label: 'Removed',
              data: removedData.map(v => -v),
              backgroundColor: isDark() ? 'rgba(252, 165, 165, 0.7)' : 'rgba(239, 68, 68, 0.7)',
              hoverBackgroundColor: isDark() ? 'rgba(252, 165, 165, 1)' : 'rgba(239, 68, 68, 1)',
              borderRadius: 4,
              borderSkipped: false
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: { display: true, labels: { color: colors.text } },
            tooltip: {
              callbacks: {
                label: (ctx) => ctx.dataset.label + ': ' + Math.abs(ctx.raw)
              }
            }
          },
          scales: {
            x: {
              stacked: true,
              grid: { display: false },
              ticks: { color: colors.text, autoSkip: false, maxRotation: 0 }
            },
            y: {
              grid: { color: colors.grid },
              ticks: {
                color: colors.text,
                callback: (v) => Math.abs(v)
              }
            }
          }
        }
      });
    };

    // Format month labels as two-level: month on top, year only at year boundary
    const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    const formatLabels = (dataSlice) => {
      let lastYear = null;
      return dataSlice.map(d => {
        const [year, month] = d.month.split('-');
        const monthLabel = monthNames[parseInt(month) - 1];
        if (year !== lastYear) {
          lastYear = year;
          return [monthLabel, year];
        }
        return monthLabel;
      });
    };

    // Show "No data available yet" message for missing data
    const showNoData = (canvasId) => {
      const canvas = document.getElementById(canvasId);
      if (canvas) {
        const container = canvas.parentElement;
        canvas.style.display = 'none';
        const msg = document.createElement('p');
        msg.textContent = 'No data available yet';
        msg.style.cssText = 'opacity: 0.5; font-style: italic; text-align: center; padding: 2rem 0;';
        container.appendChild(msg);
      }
    };

    // Exclude current (incomplete) month
    const now = new Date();
    const currentMonth = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0');

    // Fill gaps in monthly data so missing months show as 0
    const fillMonthGaps = (data, fields) => {
      if (!data || data.length < 2) return data;
      const filled = [];
      for (let i = 0; i < data.length; i++) {
        filled.push(data[i]);
        if (i < data.length - 1) {
          let [y, m] = data[i].month.split('-').map(Number);
          const [ny, nm] = data[i + 1].month.split('-').map(Number);
          m++;
          if (m > 12) { m = 1; y++; }
          while (y < ny || (y === ny && m < nm)) {
            const entry = { month: y + '-' + String(m).padStart(2, '0') };
            fields.forEach(f => entry[f] = 0);
            filled.push(entry);
            m++;
            if (m > 12) { m = 1; y++; }
          }
        }
      }
      return filled;
    };

    // Safely initialize charts with data validation
    const initCharts = (data, chartConfigs, gapFields) => {
      if (!data || !Array.isArray(data) || data.length === 0) {
        chartConfigs.forEach(config => showNoData(config.id));
        return;
      }
      const completed = data.filter(d => d.month !== currentMonth);
      const gapped = gapFields ? fillMonthGaps(completed, gapFields) : completed;
      const recent = gapped.slice(-12);
      const labels = formatLabels(recent);
      chartConfigs.forEach(config => {
        createChart(document.getElementById(config.id), labels, recent.map(d => d[config.field]), config.label);
      });
    };

    // Initialize charts
    document.addEventListener('DOMContentLoaded', () => {
      // Reading charts
      initCharts(readingData, [
        { id: 'chart-articles-archived', field: 'articles_archived', label: 'Articles' },
        { id: 'chart-total-words', field: 'total_words', label: 'Words' },
        { id: 'chart-time-spent', field: 'time_spent_minutes', label: 'Minutes' }
      ], ['articles_archived', 'total_words', 'time_spent_minutes']);

      // Books chart
      initCharts(booksData, [
        { id: 'chart-books-finished', field: 'books_finished', label: 'Books' }
      ], ['books_finished']);

      // Workout combo chart (bar + line with dual y-axes)
      if (workoutsData && Array.isArray(workoutsData) && workoutsData.length > 0) {
        const completedWorkouts = fillMonthGaps(workoutsData.filter(d => d.month !== currentMonth), ['workouts', 'total_minutes']);
        const recentWorkouts = completedWorkouts.slice(-12);
        const workoutLabels = formatLabels(recentWorkouts);
        const colors = getColors();
        new Chart(document.getElementById('chart-workout-combo'), {
          type: 'bar',
          data: {
            labels: workoutLabels,
            datasets: [
              {
                type: 'bar',
                label: 'Workouts',
                data: recentWorkouts.map(d => d.workouts),
                backgroundColor: colors.bar,
                hoverBackgroundColor: colors.barHover,
                borderRadius: 4,
                borderSkipped: false,
                yAxisID: 'y'
              },
              {
                type: 'line',
                label: 'Minutes',
                data: recentWorkouts.map(d => d.total_minutes),
                borderColor: isDark() ? 'rgba(251, 191, 36, 0.9)' : 'rgba(217, 119, 6, 0.9)',
                backgroundColor: isDark() ? 'rgba(251, 191, 36, 0.2)' : 'rgba(217, 119, 6, 0.2)',
                borderWidth: 2,
                pointRadius: 4,
                pointBackgroundColor: isDark() ? 'rgba(251, 191, 36, 1)' : 'rgba(217, 119, 6, 1)',
                tension: 0.3,
                fill: false,
                yAxisID: 'y1'
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
              legend: { display: true, labels: { color: colors.text } }
            },
            scales: {
              x: {
                grid: { display: false },
                ticks: { color: colors.text, autoSkip: false, maxRotation: 0 }
              },
              y: {
                beginAtZero: true,
                position: 'left',
                grid: { color: colors.grid },
                ticks: { color: colors.text },
                title: { display: true, text: 'Workouts', color: colors.text }
              },
              y1: {
                beginAtZero: true,
                position: 'right',
                grid: { drawOnChartArea: false },
                ticks: { color: isDark() ? 'rgba(251, 191, 36, 0.9)' : 'rgba(217, 119, 6, 0.9)' },
                title: { display: true, text: 'Minutes', color: isDark() ? 'rgba(251, 191, 36, 0.9)' : 'rgba(217, 119, 6, 0.9)' }
              }
            }
          }
        });
      } else {
        showNoData('chart-workout-combo');
      }

      // Travel combo chart (overlaid bars)
      if (travelData && Array.isArray(travelData) && travelData.length > 0) {
        const recentTravel = fillMonthGaps(travelData.filter(d => d.month !== currentMonth), ['checkins', 'unique_places']).slice(-12);
        const travelLabels = formatLabels(recentTravel);
        const colors = getColors();
        new Chart(document.getElementById('chart-travel-combo'), {
          type: 'bar',
          data: {
            labels: travelLabels,
            datasets: [
              {
                label: 'Check-ins',
                data: recentTravel.map(d => d.checkins),
                backgroundColor: colors.bar,
                hoverBackgroundColor: colors.barHover,
                borderRadius: 4,
                borderSkipped: false,
                barPercentage: 0.8,
                categoryPercentage: 0.7,
                xAxisID: 'x',
                order: 2
              },
              {
                label: 'Unique Places',
                data: recentTravel.map(d => d.unique_places),
                backgroundColor: 'rgba(239, 68, 68, 0.7)',
                hoverBackgroundColor: 'rgba(239, 68, 68, 1)',
                borderRadius: 4,
                borderSkipped: false,
                barPercentage: 0.8,
                categoryPercentage: 0.7,
                xAxisID: 'x2',
                order: 1
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
              legend: { display: true, labels: { color: colors.text } }
            },
            scales: {
              x: {
                grid: { display: false },
                ticks: { color: colors.text, autoSkip: false, maxRotation: 0 }
              },
              x2: {
                display: false,
                grid: { display: false },
                offset: true
              },
              y: {
                beginAtZero: true,
                grid: { color: colors.grid },
                ticks: { color: colors.text }
              }
            }
          }
        });
      } else {
        showNoData('chart-travel-combo');
      }

      // Movies combo chart (bar + line with dual y-axes)
      if (moviesData && Array.isArray(moviesData) && moviesData.length > 0) {
        const recentMovies = fillMonthGaps(moviesData.filter(d => d.month !== currentMonth), ['movies_watched', 'avg_rating']).slice(-12);
        const moviesLabels = formatLabels(recentMovies);
        const colors = getColors();
        new Chart(document.getElementById('chart-movies-combo'), {
          type: 'bar',
          data: {
            labels: moviesLabels,
            datasets: [
              {
                type: 'bar',
                label: 'Movies Watched',
                data: recentMovies.map(d => d.movies_watched),
                backgroundColor: colors.bar,
                hoverBackgroundColor: colors.barHover,
                borderRadius: 4,
                borderSkipped: false,
                yAxisID: 'y'
              },
              {
                type: 'line',
                label: 'Avg Rating',
                data: recentMovies.map(d => d.avg_rating),
                borderColor: isDark() ? 'rgba(251, 191, 36, 0.9)' : 'rgba(217, 119, 6, 0.9)',
                backgroundColor: isDark() ? 'rgba(251, 191, 36, 0.2)' : 'rgba(217, 119, 6, 0.2)',
                borderWidth: 2,
                pointRadius: 4,
                pointBackgroundColor: isDark() ? 'rgba(251, 191, 36, 1)' : 'rgba(217, 119, 6, 1)',
                tension: 0.3,
                fill: false,
                yAxisID: 'y1'
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
              legend: { display: true, labels: { color: colors.text } }
            },
            scales: {
              x: {
                grid: { display: false },
                ticks: { color: colors.text, autoSkip: false, maxRotation: 0 }
              },
              y: {
                beginAtZero: true,
                position: 'left',
                grid: { color: colors.grid },
                ticks: { color: colors.text },
                title: { display: true, text: 'Movies', color: colors.text }
              },
              y1: {
                beginAtZero: true,
                position: 'right',
                grid: { drawOnChartArea: false },
                ticks: { color: isDark() ? 'rgba(251, 191, 36, 0.9)' : 'rgba(217, 119, 6, 0.9)' },
                title: { display: true, text: 'Rating', color: isDark() ? 'rgba(251, 191, 36, 0.9)' : 'rgba(217, 119, 6, 0.9)' },
                max: 5
              }
            }
          }
        });
      } else {
        showNoData('chart-movies-combo');
      }

      // Podcasts charts
      initCharts(podcastsData, [
        { id: 'chart-episodes-played', field: 'episodes_played', label: 'Episodes' }
      ], ['episodes_played', 'feeds_added', 'feeds_removed']);

      // Feed changes (dual chart)
      if (podcastsData && Array.isArray(podcastsData) && podcastsData.length > 0) {
        const recentPodcasts = fillMonthGaps(podcastsData.filter(d => d.month !== currentMonth), ['feeds_added', 'feeds_removed']).slice(-12);
        const feedLabels = formatLabels(recentPodcasts);
        createDualChart(
          document.getElementById('chart-feed-changes'),
          feedLabels,
          recentPodcasts.map(d => d.feeds_added),
          recentPodcasts.map(d => d.feeds_removed)
        );
      } else {
        showNoData('chart-feed-changes');
      }
    });

    // Watch for dark mode changes (debounced to avoid reload loops)
    let lastDarkState = isDark();
    const observer = new MutationObserver(() => {
      const currentDarkState = isDark();
      if (currentDarkState !== lastDarkState) {
        lastDarkState = currentDarkState;
        location.reload();
      }
    });
    observer.observe(document.documentElement, { attributes: true, attributeFilter: ['class'] });
  </script>
</article>
{{- end -}}